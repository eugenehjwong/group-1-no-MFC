<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spatula-by-Spatula: NaOH added to H₂SO₄ — Interactive Simulation</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 14px; color:#111 }
  h1 { font-size:1.4rem; margin-bottom:6px }
  .container { display: grid; grid-template-columns: 380px 1fr; gap: 18px; align-items: start; }
  .card { background: #fbfbfd; border: 1px solid #e2e6ef; border-radius:8px; padding:12px; box-shadow: 0 1px 3px rgba(12,24,48,0.04); }
  label { display:block; font-size:0.86rem; margin-top:8px }
  input[type="number"], select { width:100%; padding:6px 8px; margin-top:6px; box-sizing:border-box; }
  .row { display:flex; gap:8px; margin-top:10px }
  button { padding:8px 12px; border-radius:6px; border: none; background:#0b74de; color:white; cursor:pointer; }
  button.secondary { background:#6c757d; }
  .beaker { width:100%; height:200px; border: 2px solid #9fb3d9; border-radius:10px; position:relative; background:linear-gradient(#e8f2ff,#ffffff); overflow:hidden; }
  .liquid { position:absolute; left:8px; right:8px; bottom:8px; border-radius:6px; background:linear-gradient(#bfe1ff,#dff5ff); box-shadow: inset 0 6px 12px rgba(0,0,0,0.04); transition: height 0.35s; display:flex; align-items:center; justify-content:center; font-weight:600; color:#044a6b }
  .readouts { font-family:monospace; font-size:0.95rem; margin-top:10px; }
  .small { font-size:0.82rem; color:#444; margin-top:6px }
  canvas { width:100% !important; height:240px !important; }
  .warning { background:#fff4e6; border:1px solid #ffd8a8; padding:8px; border-radius:6px; margin-top:8px; color:#7a4d00 }
  footer { margin-top:12px; font-size:0.82rem; color:#444 }
</style>
<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Spatula-by-spatula simulation — solid NaOH added to dilute H₂SO₄</h1>
  <div class="container">
    <div class="card">
      <strong>Initial conditions</strong>
      <label>H₂SO₄ concentration (M)</label>
      <input id="cAcid" type="number" min="0.001" step="0.001" value="0.10" />
      <label>Volume of solution (L)</label>
      <input id="vol" type="number" min="0.01" step="0.01" value="0.250" />
      <label>Mass of NaOH per spatula (grams)</label>
      <input id="spatulaMass" type="number" min="0.001" step="0.001" value="0.100" />
      <label>Fraction of spatula that actually falls into beaker (0–1)</label>
      <input id="efficiency" type="number" min="0.1" max="1" step="0.01" value="0.95" />
      <label>Model</label>
      <select id="modelSelect">
        <option value="accurate" selected>Accurate (first proton strong; second uses Ka₂)</option>
        <option value="approx">Approximate (both protons treated as strong)</option>
      </select>

      <div class="row" style="margin-top:12px">
        <button id="addSpat">Add 1 spatula</button>
        <button id="add10" class="secondary">Add 10</button>
        <button id="reset" class="secondary">Reset</button>
      </div>

      <div class="small">Mol. mass NaOH = <strong>40.00 g·mol⁻¹</strong>. Ka₂ (HSO₄⁻ ⇌ H⁺ + SO₄²⁻) used = <strong>10⁻¹.⁹⁹</strong>.</div>

      <div class="warning" style="margin-top:10px">
        Laboratory safety: adding solid NaOH to acid is exothermic and can cause splattering. Use PPE. This app is for educational simulation only — do not use it as an experimental protocol.
      </div>

      <div class="readouts">
        <div>Spatulas added: <span id="nSpat">0</span></div>
        <div>Total NaOH added (g): <span id="massNaOH">0.000</span> g</div>
        <div>Total NaOH (mol): <span id="molesNaOH">0.0000</span> mol</div>
        <div>H₂SO₄ (mol initial): <span id="molesH2SO4">0.0000</span> mol</div>
        <div>Estimated temperature rise: <span id="tempRise">0.00</span> °C</div>
        <div style="margin-top:8px">Current pH: <strong id="pHdisplay">---</strong></div>
        <div class="small">Assumptions: solution volume is constant (no volume change on dissolving), density ≈ 1 g·mL⁻¹, heat capacity Cp = 4.18 J·g⁻¹·K⁻¹, enthalpy neutralisation ≈ 57 kJ·mol⁻¹ (per mol OH⁻ neutralised).</div>
      </div>
    </div>

    <div class="card">
      <strong>Beaker view</strong>
      <div class="beaker" aria-hidden="true">
        <div id="liquid" class="liquid" style="height:60%">pH —</div>
      </div>

      <div style="margin-top:12px; display:flex; gap:12px;">
        <div style="flex:1">
          <canvas id="phChart"></canvas>
        </div>
        <div style="width:220px">
          <strong>Species (current conc.)</strong>
          <div id="speciesBox" style="font-family:monospace; margin-top:8px; font-size:0.95rem">
            [H⁺]: --- M<br/>
            [OH⁻]: --- M<br/>
            [HSO₄⁻]: --- M<br/>
            [SO₄²⁻]: --- M<br/>
            [Na⁺]: --- M
          </div>
        </div>
      </div>

      <footer>
        Tip: change spatula mass to model a light tap vs a heaping spatula. Use the "approximate" model for a quick classroom demonstration.
      </footer>
    </div>
  </div>

<script>
/*
  Simulation logic:
  - Initial moles H2SO4 = cAcid * V
  - Each spatula adds mass (g_spatula * efficiency). NaOH mol = mass / 40.00
  - Na+ total moles = moles NaOH added
  - Sulfate total (S_total) moles = initial moles H2SO4 (one sulfate per H2SO4)
  - The solver computes [H+] by electroneutrality:
      Na+ + [H+] = [HSO4-] + 2[SO4^2-] + [OH-]
    with Ka2 relation:
      [SO4] = Ka2 * [HSO4] / [H+]
    and S_total = [HSO4] + [SO4]
  - Substitute to reduce to single equation f([H+]) = 0 and solve by bisection.
  - In "approximate" mode both protons are treated as strong: net equivalents e = 2*n_H2SO4 - n_NaOH.
*/

const MM_NaOH = 40.00;
const Ka2 = Math.pow(10, -1.99); // 10^-1.99
const Kw = 1e-14;
const dH_neutral_kJ_per_mol = 57; // approximate neutralisation heat per mol OH reacted (kJ)
const Cp = 4.18; // J/g/K
const density = 1.0; // g/mL ~ 1

// HTML elements
const cAcidEl = document.getElementById('cAcid');
const volEl = document.getElementById('vol');
const spatulaMassEl = document.getElementById('spatulaMass');
const efficiencyEl = document.getElementById('efficiency');
const modelSelect = document.getElementById('modelSelect');

const addSpat = document.getElementById('addSpat');
const add10 = document.getElementById('add10');
const resetBtn = document.getElementById('reset');

const nSpatEl = document.getElementById('nSpat');
const massNaOHEl = document.getElementById('massNaOH');
const molesNaOHEl = document.getElementById('molesNaOH');
const molesH2SO4El = document.getElementById('molesH2SO4');
const pHdisplay = document.getElementById('pHdisplay');
const tempRiseEl = document.getElementById('tempRise');
const liquidEl = document.getElementById('liquid');
const speciesBox = document.getElementById('speciesBox');

let state = {
  spatulas: 0,
  massNaOH: 0.0,
  molesNaOH: 0.0,
  molesH2SO4: parseFloat(cAcidEl.value) * parseFloat(volEl.value),
  history: [] // {spatulas, pH}
};

// Chart.js setup
const ctx = document.getElementById('phChart');
let chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [0],
    datasets: [{
      label: 'pH',
      data: [null],
      tension: 0.25,
      pointRadius: 3,
      borderWidth: 2,
      fill: false
    }]
  },
  options: {
    responsive: true,
    scales: {
      x: { title: { display: true, text: 'Spatulas added' } },
      y: { title: { display: true, text: 'pH' }, min: 0, max: 14 }
    },
    plugins: { legend: { display: false } }
  }
});

function resetState() {
  state.spatulas = 0;
  state.massNaOH = 0;
  state.molesNaOH = 0;
  state.molesH2SO4 = parseFloat(cAcidEl.value) * parseFloat(volEl.value);
  state.history = [];
  chart.data.labels = [0];
  chart.data.datasets[0].data = [null];
  chart.update();
  updateDisplay();
}

function addSpatula(n=1) {
  const massPer = parseFloat(spatulaMassEl.value) || 0.1;
  const eff = Math.max(0.0, Math.min(1.0, parseFloat(efficiencyEl.value) || 1.0));
  const addedMass = massPer * eff * n;
  const addedMoles = addedMass / MM_NaOH;
  state.spatulas += n;
  state.massNaOH += addedMass;
  state.molesNaOH += addedMoles;
  updateDisplay();
}

function updateDisplay() {
  const V = parseFloat(volEl.value) || 0.25; // L
  const S_total_mol = (parseFloat(cAcidEl.value) || 0.0) * V; // moles H2SO4 -> 1 sulfate per
  state.molesH2SO4 = S_total_mol;
  nSpatEl.textContent = state.spatulas;
  massNaOHEl.textContent = state.massNaOH.toFixed(3);
  molesNaOHEl.textContent = state.molesNaOH.toFixed(4);
  molesH2SO4El.textContent = state.molesH2SO4.toFixed(4);

  const model = modelSelect.value;
  // Compute concentrations
  let conc = computeConcentrations(state.molesH2SO4, state.molesNaOH, V, model);
  // Update pH display and beaker
  let pH = conc.pH;
  pHdisplay.textContent = (isFinite(pH) ? pH.toFixed(3) : '---');
  // Update liquid color/height to reflect pH: map pH 0..14 to color gradient (red→green→blue)
  let pct = Math.max(0, Math.min(1, (pH || 7) / 14));
  let heightPct = 40 + 45 * pct; // visual fill
  liquidEl.style.height = heightPct + '%';
  liquidEl.textContent = `pH ${ (isFinite(pH) ? pH.toFixed(2) : '---') }`;
  // Temperature rise estimate (J)
  // neutralised moles = min(molesNaOH, 2*molesH2SO4)
  const neutralisedMoles = Math.min(state.molesNaOH, 2 * state.molesH2SO4);
  const energyJ = neutralisedMoles * dH_neutral_kJ_per_mol * 1000; // J
  const massSolution_g = V * 1000 * density;
  const deltaT = energyJ / (massSolution_g * Cp);
  tempRiseEl.textContent = deltaT.toFixed(2);
  // species concentrations
  speciesBox.innerHTML = `[H⁺]: ${formatConc(conc.H)} M<br/>[OH⁻]: ${formatConc(conc.OH)} M<br/>[HSO₄⁻]: ${formatConc(conc.HSO4)} M<br/>[SO₄²⁻]: ${formatConc(conc.SO4)} M<br/>[Na⁺]: ${formatConc(conc.Na)} M`;

  // update chart
  state.history.push({ spat: state.spatulas, pH: pH });
  chart.data.labels.push(state.spatulas);
  chart.data.datasets[0].data.push(isFinite(pH) ? pH : null);
  chart.update();
}

function formatConc(x) {
  if (!isFinite(x) || x === undefined) return '---';
  if (x >= 1) return x.toFixed(3);
  if (x >= 1e-3) return x.toExponential(3);
  return x.toExponential(3);
}

/* Compute concentrations.
   Inputs: molesH2SO4 (mol), molesNaOH (mol), V (L)
   model: 'accurate' or 'approx'
   Returns object {pH, H, OH, HSO4, SO4, Na}
*/
function computeConcentrations(molesH2SO4, molesNaOH, V, model) {
  if (V <= 0) V = 0.001;
  const S_total = molesH2SO4 / V; // mol·L^-1 total sulfate species
  const Na_conc = molesNaOH / V;  // mol·L^-1

  // Approximate model: treat both protons as strong acids
  if (model === 'approx') {
    const equivalents_initial = 2 * molesH2SO4;
    const eRemaining = equivalents_initial - molesNaOH; // mol of H+ equivalents left (can be negative)
    if (eRemaining > 0) {
      const H = eRemaining / V;
      const pH = -Math.log10(H);
      return { pH, H, OH: Kw / H, HSO4: 0, SO4: S_total, Na: Na_conc };
    } else if (Math.abs(eRemaining) < 1e-12) {
      // neutral: approx pH 7 (salt of strong acid/strong base)
      return { pH: 7.00, H: 1e-7, OH: 1e-7, HSO4: 0, SO4: S_total, Na: Na_conc };
    } else {
      // excess OH
      const OH = (-eRemaining) / V;
      const H = Kw / OH;
      const pH = 14 - Math.log10(OH);
      return { pH, H, OH, HSO4: 0, SO4: S_total, Na: Na_conc };
    }
  }

  // Accurate model:
  // Solve for [H+] using electroneutrality:
  // Na+ + [H+] = [HSO4-] + 2[SO4^2-] + [OH-]
  // with S_total = [HSO4] + [SO4]
  // and SO4 = Ka2 * HSO4 / H+
  // => SO4 = Ka2 * S_total / (H+ + Ka2)
  // => HSO4 = S_total - SO4 = S_total * (H+ / (H+ + Ka2))
  // Then electroneutrality becomes function f(H+) = Na + H - (HSO4 + 2*SO4 + Kw/H) = 0
  // Solve for H+ by bisection in [1e-14, 1e2]
  function fH(H) {
    const SO4 = Ka2 * S_total / (H + Ka2);
    const HSO4 = S_total - SO4;
    const OH = Kw / H;
    return Na_conc + H - (HSO4 + 2 * SO4 + OH);
  }

  // Check special easy cases to speed up:
  // If molesNaOH is extremely small vs acids, H will be large; else if huge -> basic.
  // Use bisection on log scale:
  let H_low = 1e-14, H_high = 1e2;
  let f_low = fH(H_low), f_high = fH(H_high);
  // If f_low and f_high have same sign (rare), expand bounds
  let it = 0;
  while (f_low * f_high > 0 && it < 80) {
    H_low *= 10; H_high *= 10;
    f_low = fH(H_low); f_high = fH(H_high);
    it++;
  }
  // Now normal bisection between 1e-14 and 1e2
  let H_mid = 1e-7;
  for (let i=0; i<80; i++) {
    H_mid = Math.sqrt(H_low * H_high); // geometric midpoint
    const f_mid = fH(H_mid);
    if (Math.abs(f_mid) < 1e-14) break;
    // determine which side to replace
    if (f_low * f_mid <= 0) {
      H_high = H_mid; f_high = f_mid;
    } else {
      H_low = H_mid; f_low = f_mid;
    }
  }
  const H = H_mid;
  const SO4 = Ka2 * S_total / (H + Ka2);
  const HSO4 = S_total - SO4;
  const OH = Kw / H;
  const pH = -Math.log10(H);
  return { pH, H, OH, HSO4, SO4, Na: Na_conc };
}

// Event listeners
addSpat.addEventListener('click', ()=> addSpatula(1));
add10.addEventListener('click', ()=> addSpatula(10));
resetBtn.addEventListener('click', resetState);

// Recompute on parameter changes
[cAcidEl, volEl, spatulaMassEl, efficiencyEl, modelSelect].forEach(el => {
  el.addEventListener('change', ()=> {
    // Recompute molesH2SO4 if relevant, do NOT reset spatulas (user may change model)
    state.molesH2SO4 = parseFloat(cAcidEl.value) * parseFloat(volEl.value);
    // if concentration or volume changed we may want to reset chart to avoid mismatch; keep spatulas for exploration
    updateDisplay();
  });
});

resetState();
</script>
</body>
</html>
